---
title: "6. System Timer Configuration"
date: "2025-02-06"
description: "Setting up a master timer interrupt for synchronized control loop execution."
tags: ["STM32", "Timer", "Interrupt", "Real-time"]
---

## System Timer Configuration

After completing MPs 1-5, we have several independent subsystems:
- OLED display
- MPU6050 sensor reading
- Kalman filter processing
- Encoder reading
- PWM motor control

To make them work together as a **real-time control system**, we need a **fixed-frequency master timer** that synchronizes all operations.

### Why a Fixed Control Loop?

Without a timer interrupt, using `while(1)` with delays has problems:

1. **Unknown loop time**: Processing time varies, making timing calculations unreliable
2. **Inconsistent sampling**: Kalman filter and PID require known Δt
3. **Encoder conversion**: Speed = count / time requires known time interval

### Timer Selection

We've already used:
- TIM1: PWM output
- TIM3: Left encoder
- TIM4: Right encoder

So we'll use **TIM2** for the system timer.

### Frequency Selection

| Frequency | Period | Notes |
|-----------|--------|-------|
| 20Hz | 50ms | Minimum for stable balance |
| 50Hz | 20ms | Good balance of stability and CPU load |
| 100Hz | 10ms | Better response, higher CPU usage |
| 200Hz | 5ms | Vendor reference (may require optimization) |

Start with **50Hz** and increase if needed.

### TIM2 Interrupt Configuration

```c
void Timer2_Init(void) {
    // Enable clock
    RCC_APB1PeriphClockCmd(RCC_APB1Periph_TIM2, ENABLE);
    
    // 72MHz / 1000 / 1440 = 50Hz
    TIM_TimeBaseInitTypeDef TIM_TimeBaseStructure;
    TIM_TimeBaseStructure.TIM_Prescaler = 1000 - 1;
    TIM_TimeBaseStructure.TIM_CounterMode = TIM_CounterMode_Up;
    TIM_TimeBaseStructure.TIM_Period = 1440 - 1;
    TIM_TimeBaseStructure.TIM_ClockDivision = TIM_CKD_DIV1;
    TIM_TimeBaseInit(TIM2, &TIM_TimeBaseStructure);
    
    // Enable update interrupt
    TIM_ITConfig(TIM2, TIM_IT_Update, ENABLE);
    
    // NVIC configuration
    NVIC_InitTypeDef NVIC_InitStructure;
    NVIC_InitStructure.NVIC_IRQChannel = TIM2_IRQn;
    NVIC_InitStructure.NVIC_IRQChannelPreemptionPriority = 0;
    NVIC_InitStructure.NVIC_IRQChannelSubPriority = 0;
    NVIC_InitStructure.NVIC_IRQChannelCmd = ENABLE;
    NVIC_Init(&NVIC_InitStructure);
    
    TIM_Cmd(TIM2, ENABLE);
}
```

### Interrupt Handler

```c
void TIM2_IRQHandler(void) {
    if (TIM_GetITStatus(TIM2, TIM_IT_Update) == SET) {
        
        // 1. Read sensors
        MPU6050_GetData(&AX, &AY, &AZ, &GX, &GY, &GZ);
        
        // 2. Apply bias correction
        GX_corrected = GX - gyro_bias_x;
        
        // 3. Convert to physical units
        float accel_y = AY / 16384.0f * 9.81f;
        float accel_z = AZ / 16384.0f * 9.81f;
        float gyro_x = GX_corrected / 16.4f * (M_PI / 180.0f);
        
        // 4. Kalman filter
        float accel_angle = atan2(accel_y, accel_z) * 180.0f / M_PI;
        pitch = Kalman_GetAngle(accel_angle, gyro_x, 0.02f);  // dt = 20ms
        
        // 5. Read encoders
        left_speed = Read_Encoder(3);
        right_speed = Read_Encoder(4);
        
        // 6. PID control (covered in MP7)
        int16_t pwm = PID_Calculate(pitch, gyro_x, left_speed, right_speed);
        
        // 7. Apply motor output
        Set_Motor_Speed(pwm, pwm);
        
        // Clear interrupt flag (IMPORTANT!)
        TIM_ClearITPendingBit(TIM2, TIM_IT_Update);
    }
}
```

### Critical Considerations

1. **MPU6050 sample rate must match**: If system runs at 50Hz, configure MPU6050 for ≥50Hz sampling

2. **Keep ISR short**: Avoid OLED updates in the interrupt—do them in `main()` loop

3. **Update Kalman dt**: The `dt` parameter must match actual interrupt period

4. **Clear interrupt flag**: Forgetting `TIM_ClearITPendingBit()` causes infinite interrupts

### Debugging Tips

Add a flag to signal main loop:

```c
volatile uint8_t control_flag = 0;

// In ISR:
control_flag = 1;

// In main():
while (1) {
    if (control_flag) {
        OLED_ShowNum(1, 1, pitch, 4);
        control_flag = 0;
    }
}
```

This keeps display updates out of the time-critical ISR.
